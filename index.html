<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Familieoversigt</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{--bg:#f7f7fb;--fg:#0f172a;--muted:#6b7280;--border:#e6e8ec;--accent:#0f172a;--red:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .muted{color:var(--muted)}
    .top{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:6px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-left:8px}
    .conn{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:6px;margin:10px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .bar input,.bar button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
    .bar button{background:var(--accent);color:#fff;border-color:var(--accent);cursor:pointer}
    .list{background:#fff;border:1px solid var(--border);border-radius:16px}
    .row{display:flex;align-items:center;gap:12px;padding:12px 14px;border-top:1px solid #eef0f4}
    .row:first-child{border-top:0}
    .grow{flex:1}
    .date{min-width:120px;color:#334155}
    .empty{padding:20px;color:var(--muted);text-align:center}
    .del{background:var(--red);border-color:var(--red);color:#fff;cursor:pointer;border-radius:10px;padding:8px 10px}
    /* Måned */
    .monthbar{display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px}
    .monthnav{display:flex;gap:8px}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .cell{min-height:110px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .cell .d{font-weight:700;font-size:13px;color:#334155}
    .chip{font-size:12px;border-radius:999px;padding:4px 8px;background:#f1f5f9;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .today{outline:2px solid #0ea5e9}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Familieoversigt <span id="hidPill" class="pill"></span></h1>
      <span id="conn" class="conn">Forbinder…</span>
    </div>
    <div class="muted">Realtime synk via Firebase Firestore.</div>

    <div class="tabs">
      <button class="tab active" data-view="list">Liste</button>
      <button class="tab" data-view="month">Måned</button>
    </div>

    <!-- Listevisning -->
    <section id="view-list">
      <div class="bar">
        <input id="titleIn" placeholder="Titel"/>
        <input id="dateIn" type="date"/>
        <input id="notesIn" placeholder="Noter (valgfri)"/>
        <button id="addBtn">Tilføj</button>
      </div>
      <div class="list" id="fallbackList"><div class="empty">Ingen punkter endnu.</div></div>
    </section>

    <!-- Måned -->
    <section id="view-month" hidden>
      <div class="monthbar">
        <div id="monthTitle" class="muted">—</div>
        <div class="monthnav">
          <button class="btn" id="prevM">← Forrige</button>
          <button class="btn" id="todayM">I dag</button>
          <button class="btn" id="nextM">Næste →</button>
        </div>
      </div>
      <div class="grid" id="dow">
        <div class="dow">Man</div><div class="dow">Tir</div><div class="dow">Ons</div><div class="dow">Tor</div>
        <div class="dow">Fre</div><div class="dow">Lør</div><div class="dow">Søn</div>
      </div>
      <div class="grid" id="monthGrid"></div>
    </section>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",
    authDomain: "webkiosk-e5d32.firebaseapp.com",
    projectId: "webkiosk-e5d32",
    storageBucket: "webkiosk-e5d32.firebasestorage.app",
    messagingSenderId: "920175197353",
    appId: "1:920175197353:web:c3520e9a3ab8146ec4fdb8",
    measurementId: "G-X6LHDEPS8H"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(), db=firebase.firestore();

  const HID=(new URLSearchParams(location.search).get('hid')||'DEFAULT').toUpperCase();
  const itemsCol=db.collection('households').doc(HID).collection('calendar').doc('v1').collection('items');

  const $=id=>document.getElementById(id);
  $('hidPill').textContent=HID;
  const setConn=(t)=>$('conn').textContent=t;
  window.addEventListener('online',()=>setConn('Online'));
  window.addEventListener('offline',()=>setConn('Offline'));

  // view switch
  const tabs=[...document.querySelectorAll('.tab')];
  const showView=v=>{
    tabs.forEach(t=>t.classList.toggle('active',t.dataset.view===v));
    $('view-list').hidden=(v!=='list');
    $('view-month').hidden=(v!=='month');
  };
  tabs.forEach(t=>t.addEventListener('click',()=>showView(t.dataset.view)));

  // CRUD API
  const itemsListeners=new Set();
  window.CalendarData={
    hid:HID,
    onItems(cb){itemsListeners.add(cb);return()=>itemsListeners.delete(cb);},
    async addItem({title,date,notes=''}){return itemsCol.add({
      title:title||'',date:date||null,notes:notes||'',done:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });},
    async updateItem(id,patch){patch=Object.assign({},patch,{updatedAt:firebase.firestore.FieldValue.serverTimestamp()});return itemsCol.doc(id).set(patch,{merge:true});},
    async deleteItem(id){return itemsCol.doc(id).delete();}
  };

  // Liste-render
  function renderList(items){
    const box=$('fallbackList'); box.innerHTML='';
    if(!items.length){box.innerHTML='<div class="empty">Ingen punkter endnu.</div>';return;}
    const byDate=[...items].sort((a,b)=>((a.date||'').localeCompare(b.date||'')));
    for(const it of byDate){
      const row=document.createElement('div');row.className='row';
      const cb=document.createElement('input');cb.type='checkbox';cb.checked=!!it.done;cb.onchange=()=>window.CalendarData.updateItem(it.id,{done:cb.checked});
      const title=document.createElement('div');title.className='grow';title.textContent=it.title||''; if(it.notes){title.title=it.notes;}
      const date=document.createElement('div');date.className='date';date.textContent=it.date||'';
      const del=document.createElement('button');del.className='del';del.textContent='Slet';del.onclick=()=>window.CalendarData.deleteItem(it.id);
      row.append(cb,title,date,del);box.append(row);
    }
  }

  // Måned-render
  let viewMonth=new Date(); viewMonth.setDate(1);
  const fmtMonth=(d)=>d.toLocaleDateString('da-DK',{month:'long',year:'numeric'});
  function startOfWeek(d){const r=new Date(d);const day=(r.getDay()+6)%7; r.setDate(r.getDate()-day); r.setHours(0,0,0,0); return r;}
  function addDays(d,n){const r=new Date(d); r.setDate(r.getDate()+n); return r;}
  function ymd(d){return d.toISOString().slice(0,10);}
  function renderMonth(items){
    $('monthTitle').textContent=fmtMonth(viewMonth);
    const firstDay=startOfWeek(new Date(viewMonth)); // mandag før/lig 1.
    const grid=$('monthGrid'); grid.innerHTML='';
    const todayYMD=ymd(new Date());
    // map items by date
    const map=new Map();
    for(const it of items){ if(!it.date) continue; if(!map.has(it.date)) map.set(it.date,[]); map.get(it.date).push(it); }
    for(let i=0;i<42;i++){ // 6 uger
      const d=addDays(firstDay,i);
      const cell=document.createElement('div'); cell.className='cell';
      if(ymd(d)===todayYMD) cell.classList.add('today');
      const dn=document.createElement('div'); dn.className='d'; dn.textContent=d.getDate();
      cell.append(dn);
      const list=map.get(ymd(d))||[];
      for(const it of list.slice(0,3)){ // vis max 3 chips
        const chip=document.createElement('div'); chip.className='chip'; chip.textContent=it.title||'(uden titel)';
        chip.title=(it.notes||'');
        cell.append(chip);
      }
      grid.append(cell);
    }
  }
  $('prevM').onclick=()=>{viewMonth.setMonth(viewMonth.getMonth()-1);renderMonth(cacheItems);}
  $('nextM').onclick=()=>{viewMonth.setMonth(viewMonth.getMonth()+1);renderMonth(cacheItems);}
  $('todayM').onclick=()=>{viewMonth=new Date();viewMonth.setDate(1);renderMonth(cacheItems);};

  // Data flow
  let cacheItems=[];
  function onItems(items){
    cacheItems=items;
    renderList(items);
    renderMonth(items);
  }

  // Add-knap
  $('addBtn').onclick=()=>{const t=$('titleIn').value.trim(),d=$('dateIn').value,n=$('notesIn').value.trim();if(!t){alert('Titel mangler');return;}window.CalendarData.addItem({title:t,date:d,notes:n}).then(()=>{$('titleIn').value='';$('notesIn').value='';});};

  // Realtime
  auth.signInAnonymously().then(()=>{
    setConn(navigator.onLine?'Online':'Offline');
    itemsCol.orderBy('createdAt','asc').onSnapshot(snap=>{
      const data=[]; snap.forEach(d=>data.push({id:d.id,...d.data()}));
      itemsListeners.forEach(cb=>{try{cb(data);}catch{}}); // hvis eksternt UI tilsluttes
      onItems(data); // vores egne visninger
    }, err=>{ setConn('Fejl: '+(err.code||err.message)); console.error(err); });
  }).catch(e=>{ setConn('Auth fejl'); console.error(e); });

  // Default: vis Måned, hvis åbnet fra Webkiosk; ellers Liste. Justér efter smag:
  showView('month');
  </script>
</body>
</html>
