<!-- /index.html -->
<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Player · GitHub Pages</title>
  <meta name="description" content="Spotify Web Playback SDK + PKCE på en statisk GitHub Pages-side.">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --radius:1.25rem;
    }
    html,body{height:100%}
    body{background:var(--bg); color:var(--text)}
    .container-16x9{max-width:min(1600px, calc(100vh * 1.7778)); margin-inline:auto}
    @media (orientation:landscape) and (max-width:1200px){ .container-16x9{max-width:min(1200px, calc(100vh * 1.7778))} }

    .btn-pill{border:1px solid var(--border); border-radius:9999px; padding:.5rem 1rem; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .btn-pill:hover{background:#f9fafb; box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .btn-cta{background:#111;color:#fff;border-color:#111}
    .btn-cta:hover{background:#000}

    .card-xl{background:var(--card); border:1px solid var(--border); border-radius:calc(var(--radius) * 1.4); padding:1rem; box-shadow:0 10px 20px rgba(2,8,20,.04); overflow:hidden}
    .section-title{font-weight:600}
    .grid-isolated{isolation:isolate}
    .layer-top{position:relative; z-index:2}
    .layer-base{position:relative; z-index:1}

    /* Stor, responsiv embed */
    .embed-box{position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:1rem; overflow:hidden}
    .embed-box iframe{position:absolute; inset:0; width:100%; height:100%; border:0}
    dialog:not([open]){display:none}
  </style>
</head>

<body class="min-h-screen">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="container-16x9 px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <svg viewBox="0 0 24 24" class="w-7 h-7" aria-hidden="true"><path d="M12 3C7 3 3 7 3 12s4 9 9 9 9-4 9-9-4-9-9-9Zm4.5 12.3a.9.9 0 0 1-1.23.3c-3.37-2.06-7.61-2.53-12.6-1.38a.9.9 0 0 1-.39-1.76c5.43-1.22 10.12-.7 13.85 1.56.43.26.57.82.37 1.28Zm.87-3.04a1 1 0 0 1-1.36.33c-3.78-2.33-9.54-3.01-14-1.64a1 1 0 0 1-.58-1.92c4.92-1.5 11.25-.75 15.45 1.84.48.3.62.94.35 1.39Zm.2-3.15c-4.52-2.68-12.03-2.92-16.35-1.58a1.1 1.1 0 0 1-.63-2.11C6.3 4.65 14.4 4.93 19.4 7.85a1.1 1.1 0 0 1-1.16 1.89Z"></path></svg>
        <h1 class="text-lg font-semibold">Spotify på GitHub Pages</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnStatus" type="button" class="btn-pill text-sm">Status</button>
        <button id="openSettings" type="button" class="btn-pill text-sm">Indstillinger</button>
        <a id="backLink" href="#" class="btn-pill text-sm" title="Tilbage">Tilbage</a>
      </div>
    </div>
  </header>

  <main class="container-16x9 px-4 py-6">
    <div id="alerts" class="mb-4"></div>

    <!-- Sektion 1 -->
    <section class="grid grid-isolated gap-4 lg:grid-cols-3">
      <div class="card-xl lg:col-span-2 layer-top">
        <div class="flex items-center justify-between">
          <h2 class="section-title">Afspiller</h2>
          <a href="https://open.spotify.com/" target="_blank" rel="noopener" class="text-sm underline">Åbn Spotify Web Player</a>
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-2">
          <button id="btnLogin" type="button" class="btn-pill">Log ind med Spotify</button>
          <button id="btnConnect" type="button" class="btn-pill hidden">Forbind afspiller</button>
          <span id="premiumWarn" class="text-xs text-amber-700">Premium påkrævet for afspilning i browser.</span>
        </div>

        <div class="mt-4 grid gap-4">
          <div class="flex items-center gap-2">
            <button id="btnPrev" type="button" class="btn-pill" title="Forrige">⏮</button>
            <button id="btnPlayPause" type="button" class="btn-pill" title="Afspil/Pause">⏯</button>
            <button id="btnNext" type="button" class="btn-pill" title="Næste">⏭</button>
            <label class="ml-4 text-sm">Lyd:
              <input id="vol" type="range" min="0" max="1" step="0.01" class="align-middle ml-2">
            </label>
          </div>

          <div class="flex items-center gap-2">
            <span id="posLabel" class="text-xs w-16">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" class="flex-1">
            <span id="durLabel" class="text-xs w-16 text-right">0:00</span>
          </div>

          <div id="nowPlaying" class="flex items-center gap-4">
            <img id="npCover" src="" alt="" class="w-16 h-16 rounded-xl object-cover border hidden">
            <div class="min-w-0">
              <div id="npTitle" class="font-medium truncate">–</div>
              <div id="npSub" class="text-sm text-gray-600 truncate">–</div>
              <div id="npDevice" class="text-xs text-gray-500 truncate"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-xl layer-base">
        <h2 class="section-title">Enheder</h2>
        <div class="text-xs text-gray-600">Vælg aktiv enhed (Spotify Connect).</div>
        <div id="devices" class="mt-3 space-y-2"></div>
        <button id="btnMakeThisDevice" type="button" class="btn-pill w-full mt-3 btn-cta">Afspil her i browseren</button>
      </div>
    </section>

    <!-- Sektion 2: Søg (1 kol venstre) + Stor Embed (2 kol højre) -->
    <section class="grid grid-isolated gap-4 lg:grid-cols-3 mt-6">
      <div class="card-xl lg:col-span-1 layer-top">
        <h2 class="section-title">Søg & afspil</h2>
        <div class="flex gap-2 mt-2">
          <input id="q" class="border rounded-full px-4 py-2 flex-1" placeholder="Søg efter sang, album, kunstner, playlist…">
          <button id="btnSearch" type="button" class="btn-pill">Søg</button>
        </div>
        <div id="results" class="mt-3 grid gap-2"></div>
      </div>

      <div class="card-xl lg:col-span-2 layer-base">
        <div class="flex items-center justify-between">
          <h2 class="section-title">Embed (valgfri) – stor visning</h2>
          <div class="text-xs text-gray-600">16:9 · responsiv · maksimerbar</div>
        </div>

        <input id="embedUri" class="border rounded-full px-4 py-2 mt-3 w-full" placeholder="spotify:playlist:37i9dQZF1DXcBWIGoYBM5M eller https://open.spotify.com/playlist/...">
        <div class="flex gap-2 mt-3">
          <button id="btnEmbed" type="button" class="btn-pill w-full">Vis embed</button>
          <button id="btnMaxEmbed" type="button" class="btn-pill">Maksimér</button>
          <button id="btnClearEmbed" type="button" class="btn-pill">Skjul</button>
        </div>

        <!-- Stor 16:9 boks -->
        <div id="embedHost" class="mt-4">
          <!-- fyldes dynamisk med .embed-box > iframe -->
        </div>
      </div>
    </section>
  </main>

  <!-- Indstillinger -->
  <dialog id="dlgSettings" class="rounded-2xl p-0 w-[36rem] max-w-[95vw]">
    <form method="dialog" class="p-4 space-y-3">
      <h3 class="text-lg font-semibold">Indstillinger</h3>
      <label class="block">Spotify Client ID
        <input id="cfgClientId" class="border rounded-xl px-3 py-2 w-full" placeholder="din client id">
      </label>
      <label class="block">Redirect URI (denne sides URL)
        <input id="cfgRedirectUri" class="border rounded-xl px-3 py-2 w-full" placeholder="https://<user>.github.io/<repo>/">
      </label>
      <div class="text-xs text-gray-600">Scopes anmodes automatisk ved login.</div>
      <div class="flex justify-end gap-2 pt-2">
        <button id="cfgClear" type="button" class="btn-pill">Nulstil</button>
        <button id="cfgSave" type="button" class="btn-pill btn-cta">Gem</button>
      </div>
    </form>
  </dialog>

  <!-- Maksimeret embed-dialog -->
  <dialog id="dlgEmbed" class="rounded-2xl p-0 w-[96vw] max-w-[1400px]">
    <div class="p-3 flex items-center justify-between border-b">
      <div class="font-semibold">Stor embed</div>
      <button id="dlgEmbedClose" class="btn-pill">Luk</button>
    </div>
    <div class="p-3">
      <div class="embed-box">
        <iframe id="dlgEmbedFrame" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>
    </div>
  </dialog>

  <footer class="container-16x9 px-4 pb-10 pt-6 text-xs text-gray-500">
    © <span id="year"></span> • Bygget med Spotify Web Playback SDK + PKCE. Ikke tilknyttet Spotify.
  </footer>

<script>
/* --- Konstanter/Utils --- */
const S = {
  scopes: ["streaming","user-read-playback-state","user-modify-playback-state","user-read-currently-playing","playlist-read-private"],
  authz:"https://accounts.spotify.com/authorize",
  token:"https://accounts.spotify.com/api/token",
  api:"https://api.spotify.com/v1",
};
const LS = { clientId:"sp_client_id", redirectUri:"sp_redirect_uri", codeVerifier:"sp_code_verifier", token:"sp_token" };
const $ = (id) => document.getElementById(id);
const fmt = (ms) => { const t=Math.max(0,Math.floor(ms/1000)),m=Math.floor(t/60),s=t%60; return `${m}:${s.toString().padStart(2,"0")}`; };
function setAlert(html,type="info"){ const c=document.createElement("div"); c.className="rounded-xl border p-3 text-sm "+(type==="error"?"border-red-300 bg-red-50 text-red-800":"border-gray-300 bg-gray-50"); c.innerHTML=html; $("alerts").innerHTML=""; $("alerts").appendChild(c); }
function secureUrl(u){ try{const x=new URL(u);return x.protocol==="https:";}catch{ return false; }}

/* SDK ready */
let sdkReady=false; window.onSpotifyWebPlaybackSDKReady=()=>{ sdkReady=true; };

/* --- PKCE --- */
function base64url(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
function randomString(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); const abc="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"; return Array.from(a).map(n=>abc[n%abc.length]).join(""); }
async function sha256(input){ const enc=new TextEncoder().encode(input); const hash=await crypto.subtle.digest("SHA-256",enc); return base64url(hash); }
function cfgGet(){ return { clientId:localStorage.getItem(LS.clientId)||"", redirectUri:localStorage.getItem(LS.redirectUri)||location.origin+location.pathname }; }
function cfgSet({clientId,redirectUri}){ if(clientId)localStorage.setItem(LS.clientId,clientId.trim()); if(redirectUri)localStorage.setItem(LS.redirectUri,redirectUri.trim()); }
function cfgClear(){ localStorage.removeItem(LS.clientId); localStorage.removeItem(LS.redirectUri); localStorage.removeItem(LS.token); localStorage.removeItem(LS.codeVerifier); }

async function startLogin(){
  const {clientId,redirectUri}=cfgGet();
  if(!clientId || !redirectUri || !secureUrl(redirectUri)){ setAlert("Udfyld Client ID og en gyldig HTTPS Redirect URI i Indstillinger.", "error"); $("openSettings").click(); return; }
  const verifier=randomString(64);
  localStorage.setItem(LS.codeVerifier,verifier);
  const challenge=await sha256(verifier);
  const params=new URLSearchParams({ response_type:"code", client_id:clientId, redirect_uri:redirectUri, code_challenge_method:"S256", code_challenge:challenge, scope:S.scopes.join(" ") });
  location.href=`${S.authz}?${params.toString()}`;
}
async function exchangeToken(authCode){
  const {clientId,redirectUri}=cfgGet();
  const code_verifier=localStorage.getItem(LS.codeVerifier);
  const body=new URLSearchParams({ grant_type:"authorization_code", code:authCode, redirect_uri:redirectUri, client_id:clientId, code_verifier });
  const r=await fetch(S.token,{ method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body });
  if(!r.ok) throw new Error("Token exchange fejlede ("+r.status+")");
  const tok=await r.json(); const expAt=Date.now()+(tok.expires_in*1000)-60000;
  localStorage.setItem(LS.token, JSON.stringify({...tok, expAt}));
}
async function refreshToken(){
  const raw=localStorage.getItem(LS.token); if(!raw) return;
  const tok=JSON.parse(raw); if(!tok.refresh_token) return;
  const {clientId}=cfgGet();
  const body=new URLSearchParams({ grant_type:"refresh_token", refresh_token:tok.refresh_token, client_id:clientId });
  const r=await fetch(S.token,{ method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body });
  if(!r.ok) return;
  const nt=await r.json(); const expAt=Date.now()+(nt.expires_in*1000)-60000;
  localStorage.setItem(LS.token, JSON.stringify({ ...tok, ...nt, expAt }));
}
function getTokenSync(){ const raw=localStorage.getItem(LS.token); return raw?JSON.parse(raw):null; }
async function ensureToken(){ const tok=getTokenSync(); if(!tok) return null; if(Date.now()>(tok.expAt||0)){ await refreshToken(); return getTokenSync(); } return tok; }

/* --- API helper --- */
async function api(path, init={}, retry=true){
  const tok=await ensureToken(); if(!tok) throw new Error("Ikke logget ind");
  const headers=new Headers(init.headers||{});
  headers.set("Authorization",`Bearer ${tok.access_token}`);
  if(init.body && !headers.has("Content-Type")) headers.set("Content-Type","application/json");
  const res=await fetch(S.api+path,{ ...init, headers });
  if(res.status===401 && retry){ await refreshToken(); return api(path, init, false); }
  if(res.status===204) return null;
  if(!res.ok){ let msg=""; try{const j=await res.json(); msg=j.error?.message||JSON.stringify(j);}catch{} throw new Error(`API-fejl ${res.status}: ${msg||res.statusText}`); }
  return res.json();
}

/* --- Player/UI --- */
let player=null, deviceId=null, playing=false, duration=0, position=0, positionTimer=null;
const arr = (x)=> Array.isArray(x) ? x.filter(Boolean) : [];
const artistNames = (x)=> arr(x?.artists).map(a=>a?.name).filter(Boolean).join(", ") || "–";
const ownerName = (p)=> p?.owner?.display_name || p?.owner?.id || "Playlist";

function updateNowPlayingUI(state){
  const track=state?.track_window?.current_track;
  duration=state?.duration||0; position=state?.position||0;
  $("seek").value=duration?Math.floor((position/duration)*100):0;
  $("posLabel").textContent=fmt(position); $("durLabel").textContent=fmt(duration);
  if(track){
    const img=track.album?.images?.[0]?.url||"";
    if(img){ $("npCover").src=img; $("npCover").classList.remove("hidden"); }
    $("npTitle").textContent=track.name||"–";
    $("npSub").textContent=artistNames(track);
  }
}
function startPositionTimer(){
  if(positionTimer) clearInterval(positionTimer);
  positionTimer=setInterval(()=>{ if(playing && duration>0){ position=Math.min(duration,position+1000); $("seek").value=Math.floor((position/duration)*100); $("posLabel").textContent=fmt(position);} },1000);
}
async function loadDevices(){
  const data=await api("/me/player/devices");
  const box=$("devices"); box.innerHTML="";
  (data?.devices||[]).forEach(d=>{
    const btn=document.createElement("button");
    btn.type="button";
    btn.className="btn-pill w-full text-left "+(d.is_active?"bg-gray-900 text-white border-gray-900":"");
    btn.innerHTML=`<div class="font-medium">${d.name||"(ukendt enhed)"}</div><div class="text-xs text-gray-600">${d.type||"Enhed"}${d.is_active?" • aktiv":""}</div>`;
    btn.onclick=async()=>{ await api("/me/player",{ method:"PUT", body:JSON.stringify({ device_ids:[d.id], play:true }) }); setAlert(`Overført afspilning til <strong>${d.name||"enhed"}</strong>.`); await syncState(); };
    box.appendChild(btn);
  });
  $("npDevice").textContent=deviceId?"Browser-enhed er tilgængelig":"";
}
async function playUris(uris){ await api(`/me/player/play?device_id=${encodeURIComponent(deviceId)}`,{ method:"PUT", body:JSON.stringify({ uris }) }); await syncState(); }
async function playContext(context_uri){ await api(`/me/player/play?device_id=${encodeURIComponent(deviceId)}`,{ method:"PUT", body:JSON.stringify({ context_uri }) }); await syncState(); }
async function syncState(){ try{ const st=await player.getCurrentState(); if(st){ playing=!st.paused; updateNowPlayingUI(st); $("btnPlayPause").textContent=st.paused?"▶️":"⏸"; } }catch{} }

/* --- Navigation/Bindings --- */
function initBackLink(){
  const p=new URLSearchParams(location.search); const back=p.get("back");
  $("year").textContent=new Date().getFullYear();
  if(back && secureUrl(back)) $("backLink").href=back;
  $("backLink").addEventListener("click",(e)=>{ if(!back){ e.preventDefault(); history.length>1?history.back():location.assign("/"); } });
}
function bindEvents(){
  $("btnLogin").addEventListener("click", startLogin);

  $("btnConnect").addEventListener("click", async ()=>{
    if(!sdkReady && !window.Spotify){ setAlert("Spotify SDK ikke klar endnu.", "error"); return; }
    if(player) player.disconnect();
    player=new Spotify.Player({
      name:"GitHub Pages Player",
      getOAuthToken:async cb=>{ const tok=await ensureToken(); if(!tok) return setAlert("Log ind først.", "error"); cb(tok.access_token); },
      volume:0.7
    });
    player.addListener("ready",({device_id})=>{ deviceId=device_id; setAlert("Browser-enhed klar. Vælg ‘Afspil her i browseren’ eller start et nummer.", "info"); loadDevices(); });
    player.addListener("not_ready",()=>{ deviceId=null; });
    player.addListener("player_state_changed",(st)=>{ if(!st) return; playing=!st.paused; updateNowPlayingUI(st); $("btnPlayPause").textContent=st.paused?"▶️":"⏸"; startPositionTimer(); });
    player.connect();
  });

  $("btnMakeThisDevice").addEventListener("click", async()=>{
    if(!deviceId){ setAlert("Forbind afspilleren først.", "error"); return; }
    await api("/me/player",{ method:"PUT", body:JSON.stringify({ device_ids:[deviceId], play:true }) });
    await syncState(); setAlert("Afspilning overført til denne browser-enhed.");
  });

  $("btnPlayPause").addEventListener("click", ()=>{ player&&player.togglePlay(); });
  $("btnNext").addEventListener("click", ()=>{ player&&player.nextTrack(); });
  $("btnPrev").addEventListener("click", ()=>{ player&&player.previousTrack(); });
  $("vol").addEventListener("input", (e)=>{ player&&player.setVolume(parseFloat(e.target.value)); });
  $("seek").addEventListener("input", async (e)=>{ if(!duration) return; const pos=Math.floor((parseInt(e.target.value,10)/100)*duration); try{ await player.seek(pos);}catch{} $("posLabel").textContent=fmt(pos); });

  $("btnSearch").addEventListener("click", doSearch);

  $("btnEmbed").addEventListener("click", ()=>{
    const raw=$("embedUri").value.trim();
    const url=toEmbedUrl(raw);
    if(!url){ setAlert("Ugyldig Spotify URI/URL.", "error"); return; }
    $("embedHost").innerHTML=`<div class="embed-box"><iframe src="${url}" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>`;
    // Opdater dialogens iframe også, hvis den er åben
    const dlgFrame=$("dlgEmbedFrame"); if(dlgFrame) dlgFrame.src=url;
  });
  $("btnMaxEmbed").addEventListener("click", ()=>{
    const raw=$("embedUri").value.trim(); const url=toEmbedUrl(raw);
    if(!url){ setAlert("Vis først et gyldigt embed.", "error"); return; }
    $("dlgEmbedFrame").src=url; $("dlgEmbed").showModal();
  });
  $("dlgEmbedClose").addEventListener("click", ()=>$("dlgEmbed").close());
  $("btnClearEmbed").addEventListener("click", ()=>{ $("embedHost").innerHTML=""; });

  $("openSettings").addEventListener("click", ()=>{ const dlg=$("dlgSettings"); $("cfgClientId").value=(cfgGet().clientId||""); $("cfgRedirectUri").value=(cfgGet().redirectUri||""); dlg.showModal(); });
  $("cfgSave").addEventListener("click", (e)=>{ e.preventDefault(); cfgSet({ clientId:$("cfgClientId").value, redirectUri:$("cfgRedirectUri").value }); $("dlgSettings").close(); setAlert("Indstillinger gemt."); });
  $("cfgClear").addEventListener("click", ()=>{ cfgClear(); setAlert("Indstillinger nulstillet."); });

  $("btnStatus").addEventListener("click", showStatus);
}

/* --- Søg/Embed helpers --- */
async function doSearch(){
  const q=$("q").value.trim(); if(!q) return;
  try{
    const params=new URLSearchParams({ q, type:"track,album,playlist", limit:"10" });
    const data=await api(`/search?${params}`); renderResults(data);
  }catch(e){ console.error(e); setAlert("Søgning fejlede: "+e.message, "error"); }
}
function renderResults(data){
  const out=[], host=$("results"); host.innerHTML="";
  function card(line1,line2,playFn){
    const el=document.createElement("div");
    el.className="border rounded-2xl p-3 flex items-center justify-between gap-3 bg-white";
    el.style.position="relative"; el.style.zIndex="2";
    el.innerHTML=`<div class="min-w-0"><div class="font-medium truncate">${line1||"–"}</div><div class="text-xs text-gray-600 truncate">${line2||"–"}</div></div>`;
    const b=document.createElement("button"); b.type="button"; b.className="btn-pill"; b.textContent="Afspil her"; b.onclick=playFn; el.appendChild(b); out.push(el);
  }
  const arr = (x)=> Array.isArray(x) ? x.filter(Boolean) : [];
  const artistNames = (x)=> arr(x?.artists).map(a=>a?.name).filter(Boolean).join(", ") || "–";
  const ownerName = (p)=> p?.owner?.display_name || p?.owner?.id || "Playlist";
  arr(data?.tracks?.items).forEach(t => card(t?.name, artistNames(t), ()=>playUris([t?.uri].filter(Boolean))));
  arr(data?.albums?.items).forEach(a => card(a?.name, artistNames(a), ()=>playContext(a?.uri)));
  arr(data?.playlists?.items).forEach(p => card(p?.name, ownerName(p), ()=>playContext(p?.uri)));
  out.forEach(x=>host.appendChild(x)); if(out.length===0) setAlert("Ingen resultater. Prøv et andet søgeord.", "info");
}
function toEmbedUrl(input){
  if(!input) return null;
  try{
    if(input.startsWith("spotify:")){ const [,type,id]=input.split(":"); if(!type||!id) return null; return `https://open.spotify.com/embed/${type}/${id}`; }
    if(input.startsWith("http")){ const u=new URL(input); if(u.hostname!=="open.spotify.com") return null;
      const [type,id]=u.pathname.replace(/^\/+|\/+$/g,"").split("/"); if(!type||!id) return null; return `https://open.spotify.com/embed/${type}/${id}`; }
  }catch{ return null; }
  return null;
}
async function showStatus(){
  const tok=getTokenSync(); if(!tok){ setAlert("Ingen token. Klik ‘Log ind’.", "error"); return; }
  let me=""; try{ const m=await api("/me"); me=`${m.display_name||m.id} (${m.country||"-"})`; }catch(e){ me="fejl: "+e.message; }
  let test=""; try{ const d=await api(`/search?${new URLSearchParams({ q:"test", type:"track", limit:"1" })}`); test=`OK (${d?.tracks?.items?.length||0})`; }catch(e){ test="fejl: "+e.message; }
  const exp=new Date((tok.expAt||0)).toLocaleTimeString();
  setAlert(`<div class="font-mono text-sm">scopes: ${tok.scope||"(ukendt)"}<br>udløber ca.: ${exp}<br>/me: ${me}<br>search: ${test}</div>`);
}

/* --- Boot --- */
document.addEventListener("DOMContentLoaded", async ()=>{
  initBackLink(); bindEvents(); $("year").textContent=new Date().getFullYear();
  const p=new URLSearchParams(location.search);
  if(p.has("code")){
    try{ await exchangeToken(p.get("code")); history.replaceState({}, "", location.pathname); setAlert("Login OK. Forbind afspilleren.", "info"); }
    catch(err){ console.error(err); setAlert("Login/token-fejl. "+err.message, "error"); }
  }
  if(getTokenSync()){ $("btnConnect").classList.remove("hidden"); }
});
</script>
</body>
</html>
