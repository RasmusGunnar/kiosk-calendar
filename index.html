<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Familieoversigt – Kalender</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{--bg:#f7f8fa;--fg:#0f172a;--muted:#6b7280;--border:#e6e8ec;--accent:#0f172a;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    h1{margin:0;font-size:22px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:12px}
    .status{font-size:12px;color:var(--muted)}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
    input[type="date"]{padding:9px 10px}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;cursor:pointer}
    .panel{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .row{display:flex;align-items:center;gap:12px;padding:12px 14px;border-top:1px solid #eef0f4}
    .row:first-child{border-top:0}
    .grow{flex:1;min-width:160px}
    .date{min-width:120px;color:#334155}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.danger{border-color:#fecaca;background:#fff;color:#b91c1c}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    .topnote{margin-top:4px;color:var(--muted);font-size:12px}
    .conn.ok{color:var(--ok)} .conn.warn{color:var(--warn)} .conn.err{color:var(--err)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Familieoversigt</h1>
        <div class="topnote">Synk på tværs via Firebase Firestore. Husk at åbne fra Webkiosk med samme <code>?hid=…</code>.</div>
      </div>
      <div>
        <span id="hidPill" class="pill">HID: —</span><br/>
        <span id="conn" class="status">Forbinder…</span>
      </div>
    </header>

    <section aria-label="Tilføj">
      <div class="bar">
        <input id="titleIn" placeholder="Titel (fx Hente børn)"/>
        <input id="dateIn" type="date"/>
        <input id="notesIn" placeholder="Noter (valgfri)"/>
        <button id="addBtn" class="primary">Tilføj</button>
      </div>
    </section>

    <section class="panel" aria-label="Liste">
      <div id="list"><div class="empty">Ingen punkter endnu.</div></div>
    </section>
  </div>

  <!-- Firebase compat SDKs (kræves for GitHub Pages uden bundling) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  // ---------- Konfiguration ----------
  const firebaseConfig = {
    apiKey: "AIzaSyA_gh8y-V6kkl95hRzb0ldBxpKWFY5bAck",
    authDomain: "webkiosk-e5d32.firebaseapp.com",
    projectId: "webkiosk-e5d32",
    storageBucket: "webkiosk-e5d32.firebasestorage.app",
    messagingSenderId: "920175197353",
    appId: "1:920175197353:web:c3520e9a3ab8146ec4fdb8",
    measurementId: "G-X6LHDEPS8H"
  };

  // ---------- Utils ----------
  const $ = (id)=>document.getElementById(id);
  const qs = new URLSearchParams(location.search);
  const HID = (qs.get('hid') || 'DEFAULT').toUpperCase();
  const setConn = (txt, cls='') => { const c=$('conn'); c.textContent = txt; c.className = 'status conn '+cls; };
  $('hidPill').textContent = 'HID: ' + HID;

  // ---------- Firebase init ----------
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Samling: households/{HID}/calendar/v1/items
  const itemsCol = db.collection('households').doc(HID)
                     .collection('calendar').doc('v1').collection('items');

  // Eksplicit indexering/orden
  const qItems = itemsCol.orderBy('date','asc').orderBy('createdAt','asc');

  // ---------- Render ----------
  function render(items){
    const list = $('list');
    if (!items || !items.length){
      list.innerHTML = '<div class="empty">Ingen punkter endnu.</div>';
      return;
    }
    list.innerHTML = '';
    for (const it of items){
      const row = document.createElement('div');
      row.className = 'row';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!it.done;
      cb.onchange = () => updateItem(it.id, { done: cb.checked });

      const title = document.createElement('div');
      title.className = 'grow';
      title.textContent = it.title || '';
      if (it.notes) title.title = it.notes;

      const date = document.createElement('div');
      date.className = 'date';
      date.textContent = it.date || '';

      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'Slet';
      del.onclick = () => deleteItem(it.id);

      row.append(cb, title, date, del);
      list.append(row);
    }
  }

  // ---------- CRUD ----------
  function addItem({title, date, notes=''}) {
    return itemsCol.add({
      title: title || '',
      date: date || null,
      notes: notes || '',
      done: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  function updateItem(id, patch) {
    patch = Object.assign({}, patch, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    return itemsCol.doc(id).set(patch, { merge:true });
  }
  function deleteItem(id) {
    return itemsCol.doc(id).delete();
  }

  // ---------- UI handlers ----------
  $('addBtn').onclick = () => {
    const title = $('titleIn').value.trim();
    const date  = $('dateIn').value;
    const notes = $('notesIn').value.trim();
    if (!title) { alert('Skriv en titel.'); return; }
    addItem({title, date, notes}).then(()=>{
      $('titleIn').value = '';
      $('notesIn').value = '';
    }).catch(e=>alert('Kunne ikke tilføje: '+(e.message||e)));
  };

  // ---------- Realtime + diagnostics ----------
  auth.signInAnonymously().then(()=>{
    setConn('Online', 'ok');
    qItems.onSnapshot(snap=>{
      const data=[]; snap.forEach(d=>data.push({id:d.id, ...d.data()}));
      render(data);
      console.log('[CAL] items:', data.length);
    }, err=>{
      console.error('[CAL] snapshot error', err);
      setConn('Fejl: '+(err.code||err.message), 'err');
    });
  }).catch(e=>{
    console.error('[CAL] auth error', e);
    setConn('Auth-fejl', 'err');
  });

  // ---------- Hurtig test (valgfrit): ?caltest=1 skriver en testpost ----------
  if (qs.get('caltest') === '1') {
    addItem({
      title:'Synk-test',
      date:new Date().toISOString().slice(0,10),
      notes:'auto'
    }).then(()=>console.log('[CAL] test write ok'))
      .catch(e=>console.error('[CAL] test write fail', e));
  }

  // ---------- Tip: eksporter mini-API til evt. ældre UI-komponenter ----------
  window.CalendarData = {
    hid: HID,
    onItems(cb){ return qItems.onSnapshot(s=>{const arr=[]; s.forEach(d=>arr.push({id:d.id,...d.data()})); try{cb(arr);}catch{} }, e=>console.error('[CAL] onItems err',e)); },
    addItem, updateItem, deleteItem
  };
  </script>
</body>
</html>
